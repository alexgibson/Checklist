/**
 * @author Alex Gibson
 * @name Checklist
 * @desc Checklist is an easy to use web app for creating quick to-do or shopping lists.
 *//*global $, Backbone, _, Store, Tap, console */$(function(){var e,t,n,r,i,s,o,u,a,f,l,c;e=Backbone.Model.extend({defaults:function(){return{text:"empty item",order:a.nextOrder(),done:!1}},validate:function(e){if(!_.isString(e.text))return"Text attribute must be a string";if(!_.isBoolean(e.done))return"Done attribute must be a boolean";if(!_.isNumber(e.order))return"Order attribute must be a number"},initialize:function(){this.get("title")||this.set({title:this.defaults.title});this.bind("error",function(e,t){console.error(t)})},toggle:function(){this.save({done:!this.get("done")})},clear:function(){this.destroy()}});t=Backbone.Collection.extend({model:e,localStorage:new Store("items"),done:function(){return this.filter(function(e){return e.get("done")})},remaining:function(){return this.without.apply(this,this.done())},nextOrder:function(){return this.length?this.last().get("order")+1:1}});n=Backbone.Router.extend({routes:{"":"defaultRoute",settings:"settings","add/:id":"add","edit/:id":"edit"},initialize:function(e){this.collection=e.collection;this.appView=e.appView},settings:function(){var e=new s({collection:this.collection});this.appView.showView(e);this.collection.fetch();e.trigger("rendered")},add:function(e){var t=new u({collection:this.collection});this.appView.showView(t);this.collection.fetch();$("#new-item-name").val(decodeURIComponent(e.replace(/\+/g," ")))},edit:function(e){var t,n;this.collection.fetch();t=this.collection.get(e);if(t!==undefined){n=new o({model:t});this.appView.showView(n);n.trigger("rendered")}else l.navigate("",{trigger:!0})},defaultRoute:function(){var e=new u({collection:this.collection});this.appView.showView(e);this.collection.fetch()}});r=Backbone.View.extend({showView:function(e){this.currentView&&this.currentView.destroy();this.currentView=e;this.currentView.render();$("#app-view").html(this.currentView.el)}});i=Backbone.View.extend({tagName:"li",template:_.template($("#item-template").html()),events:{"click .check":"toggleDone","tap .item-text":"toggleDone","tap .edit":"editItem","keypress .edit":"editOnEnter"},initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.remove,this)},render:function(){$(this.el).html(this.template(this.model.toJSON()));this.setText();return this},setText:function(){var e=this.model.escape("text");this.$(".item-text").html(e)},toggleDone:function(){this.model.toggle()},editItem:function(){l.navigate("edit/"+this.model.get("id"),{trigger:!0})},editOnEnter:function(e){if(e.keyCode!==13)return;l.navigate("edit/"+this.model.get("id"),{trigger:!0})},remove:function(){$(this.el).unbind();$(this.el).remove()},clear:function(){this.model.clear()}});s=Backbone.View.extend({tagName:"section",settingsTemplate:_.template($("#settings-template").html()),events:{"click #clear-completed":"clearCompleted","click #clear-all":"clearAll","click #uncheck-all":"uncheckAll","tap #close-settings":"closeSettings","keypress #close-settings":"closeOnEnter"},initialize:function(e){this.bind("rendered",this.afterRender,this);this.collection=e.collection;this.clearCompletedFlag=!1;this.uncheckAllFlag=!1;this.clearAllFlag=!1},render:function(){$(this.el).html(this.settingsTemplate());return this},afterRender:function(){this.updateEmailLink()},clearCompleted:function(){this.clearCompletedFlag=!this.clearCompletedFlag},clearAll:function(){this.clearAllFlag=!this.clearAllFlag},uncheckAll:function(){this.uncheckAllFlag=!this.uncheckAllFlag},updateEmailLink:function(){var e="mailto:?",t="My list",n="";_.each(this.collection.models,function(e){n+=e.get("text")+"\n"});e+="subject="+encodeURIComponent(t);e+="&body="+encodeURIComponent(n);e+=encodeURIComponent("\n\nCreate your own list at: http://alexgibson.github.com/checklist/\n");$("#maillink").attr("href",e);return!1},updateCollection:function(){this.clearCompletedFlag&&_.each(this.collection.done(),function(e){e.clear()});this.uncheckAllFlag&&_.each(this.collection.done(),function(e){e.save({done:!1})});if(this.clearAllFlag)while(this.collection.models.length>0)this.collection.models[0].destroy();l.navigate("",{trigger:!0})},closeSettings:function(){this.updateCollection()},closeOnEnter:function(e){if(e.keyCode!==13)return;this.updateCollection()},destroy:function(){this.unbind();this.remove()}});o=Backbone.View.extend({tagName:"section",editTemplate:_.template($("#edit-template").html()),events:{"tap #save-edit":"saveItem","click #clear":"clearItem","keypress #edit-field":"saveOnEnter","keypress #save-edit":"saveOnEnter","click #edit-completed":"toggleDone"},initialize:function(e){this.model=e.model;this.bind("rendered",this.afterRender,this);this.clear=!1},render:function(){$(this.el).html(this.editTemplate(this.model.toJSON()));return this},afterRender:function(){this.updateShareLink()},saveItem:function(){if(this.input==="")return;if(this.clear)this.model.destroy();else{this.input=$("#edit-field").val();this.model.save({text:this.input})}l.navigate("",{trigger:!0})},saveOnEnter:function(e){var t=$("#edit-field").val();if(!t||e.keyCode!==13)return;e.preventDefault();this.saveItem()},toggleDone:function(){this.model.toggle()},clearItem:function(){this.clear=!this.clear},updateShareLink:function(){var e="mailto:?",t="New item for your checklist",n=this.model.get("text");e+="subject="+encodeURIComponent(t);e+="&body=http://alexgibson.github.com/checklist/#add/"+encodeURIComponent(n.replace(/\ /g,"+"));$("#share-item-link").attr("href",e);return!1},destroy:function(){this.unbind();this.remove()}});u=Backbone.View.extend({tagName:"section",statsTemplate:_.template($("#totals-template").html()),emptyListTemplate:_.template($("#empty-list-template").html()),listTemplate:_.template($("#list-template").html()),settingsTemplate:_.template($("#settings-bar-template").html()),events:{"keypress #new-item-name":"createOnEnter","tap #add-button":"createOnSubmit","tap .settings":"openSettings","keypress .settings":"settingsOnEnter"},initialize:function(e){this.collection=e.collection;this.collection.bind("add",this.addOne,this);this.collection.bind("reset",this.addAll,this);this.collection.bind("all",this.render,this)},render:function(){var e=this.collection.length;this.$("#todo-stats").html(this.statsTemplate({total:e,done:this.collection.done().length,remaining:this.collection.remaining().length}));this.$("#empty-list").html(this.emptyListTemplate({total:e}));this.$("#settings-bar").html(this.settingsTemplate({total:e}));document.title="Checklist ("+this.collection.remaining().length+")";return this},addOne:function(e){var t=new i({model:e});$("#todo-list").append(t.render().el)},addAll:function(){$(this.el).html(this.listTemplate());this.collection.each(this.addOne)},createOnEnter:function(e){var t=$("#new-item-name"),n=t.val();if(!n||e.keyCode!==13)return;e.preventDefault();this.collection.create({text:n});t.val("").blur()},createOnSubmit:function(e){var t=$("#new-item-name"),n=t.val();if(!n)return;e.preventDefault();this.collection.create({text:n});t.val("")},openSettings:function(){l.navigate("settings",{trigger:!0})},settingsOnEnter:function(e){if(e.keyCode!==13)return;l.navigate("settings",{trigger:!0})},destroy:function(){this.unbind();this.remove();this.collection.unbind("add",this.addOne);this.collection.unbind("reset",this.addAll);this.collection.unbind("all",this.render)}});a=new t;f=new r;l=new n({collection:a,appView:f});c=new Tap(document.getElementById("app-view"));Backbone.history.start()});